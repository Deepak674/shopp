/*!
 * checkout.js - Shopp catalog behaviors library
 * Copyright Â© 2008-2010 by Ingenesis Limited
 * Licensed under the GPLv3 {@see license.txt}
 */
;jQuery(document).ready(function(){var d=jqnc(),m=false,e=d(".sameaddress"),c=d("#submit-login-checkout"),n=d("#account-login-checkout"),j=d("#password-login-checkout"),l=d("#guest-checkout"),k=d("#checkout.shopp"),q=d("#checkout.shopp [name=paymethod]"),a=d("#billing-locale"),r=d("#billing-card"),o=d("#billing-cardtype"),t=d(".payoption-button"),b=d(".payoption-"+decodeURIComponent(d_pm)),p=d("#shopp-checkout-function"),h=d("#checkout.shopp li.locale");if(k.find("input[name=checkout]").val()=="process"){t.hide();if(b.length==0){b=d(".payoption-0")}b.show();q.change(g).change()}k.bind("shopp_validate",function(){if(!f()){this.shopp_validation=["Not a valid card number.",r.get(0)]}});r.change(f);o.change(function(){var v=new String(o.val()).toLowerCase(),u=paycards[v];d(".paycard.xcsc").attr("disabled",true).addClass("disabled");if(!u||!u.inputs){return}d.each(u.inputs,function(w,x){d("#billing-xcsc-"+w).attr("disabled",false).removeClass("disabled")})}).change();o.change(function(){var u=new String(o.val()).toLowerCase();for(var v in paycards){if(k.hasClass("cardtype-"+v)){k.removeClass("cardtype-"+v)}}k.addClass("cardtype-"+u)}).change();if(a.children().size()==0){h.hide()}c.click(function(u){k.unbind("submit.validate").bind("submit.validlogin",function(w){var v=false;if(""==j.val()){v=[$co.loginpwd,j]}if(""==n.val()){v=[$co.loginname,n]}if(v){w.preventDefault();k.unbind("submit.validlogin").bind("submit.validate",function(x){return validate(this)});alert(v[0]);v[1].focus().addClass("error");return false}p.val("login")})});d("#billing-country, .billing-state, #shipping-country, .shipping-state").bind("change.localemenu",function(x,A){var z=e.is(":checked")?e.val():false,y="shipping"==z?d("#billing-country").val():d("#shipping-country").val(),w="shipping"==z?d('.billing-state[disabled!="true"]').val():d('.shipping-state[disabled!="true"]').val(),B=y+w,v,u;if(A||!a.get(0)||(!z&&(d(this).is("#billing-country")||d(this).is(".billing-state")))){return}a.empty().attr("disabled",true);if(locales&&(u=locales[B])||(u=locales[y])){v+="<option></option>";d.each(u,function(D,C){v+='<option value="'+C+'">'+C+"</option>"});d(v).appendTo(a);a.removeAttr("disabled");h.show()}});l.change(function(u){var v=k.find("input.passwords"),w=[];d.each(v,function(){w.push("label[for="+d(this).attr("id")+"]")});w=k.find(w.join(","));if(l.is(":checked")){v.setDisabled(true).hide();w.hide()}else{v.setDisabled(false).show();w.show()}}).trigger("change");d("#shopp form").on("change",".shipmethod",function(){if(d.inArray(d("#checkout #shopp-checkout-function").val(),["process","confirmed"])!=-1){var w=".shopp-cart.cart-",z="span"+w,x="input"+w,y=["shipping","tax","total"],C=[],D={},u=0,B=".shopp .shipmethod, .payoption-button input",A=d(this),v=function(){d(B).attr("disabled",true);d.getJSON($co.ajaxurl+"?action=shopp_ship_costs&method="+A.val(),function(E){if(!E&&u++<2){return setTimeout(v,1000)}d(B).attr("disabled",false);d.each(y,function(G,F){if(!E||undefined==E[F]){d(z+F).html(D[F]);return}d(z+F).html(asMoney(new Number(E[F])));d(x+F).val(new Number(E[F]))})})};d.each(y,function(F,E){C.push(z+E);D[E]=d(z+E).html()});if(!c_upd){c_upd="?"}d(C.join(",")).html(c_upd);v()}else{d(this).parents("form").submit()}});d(window).load(function(){d(document).trigger("shopp_paymethod",[q.val()])});function g(z){var y=d(this),x=decodeURIComponent(d(this).val()),u=d(".payoption-"+x),w="",v=false;if(this!=window&&y.attr&&"radio"==y.attr("type")&&!y.is(":checked")){return}d(document).trigger("shopp_paymethod",[x]);t.hide();if(u.length==0){u=d(".payoption-0")}if(pm_cards[x]&&pm_cards[x].length>0){k.find(".payment,.paycard").show();k.find(".paycard.disabled").attr("disabled",false).removeClass("disabled");if(typeof(paycards)!=="undefined"){d.each(pm_cards[x],function(A,B){if(!paycards[B]){return}v=paycards[B];w+='<option value="'+v.symbol+'">'+v.name+"</option>"});o.html(w).change()}}else{k.find(".payment,.paycard").hide();k.find(".paycard").attr("disabled",true).addClass("disabled")}u.show()}function f(){if(r.length==0){return true}if(r.attr("disabled")){return true}var u=r.val().replace(/\D/g,""),x=q.filter(":checked").val()?q.filter(":checked").val():q.val(),w=false;if(!x){x=decodeURIComponent(d_pm)}if(r.val().match(/(X)+\d{4}/)){return true}if(!pm_cards[x]){return true}d.each(pm_cards[x],function(v,z){var y=paycards[z],A=new RegExp(y.pattern.substr(1,y.pattern.length-2));if(u.match(A)){w=y.symbol;return o.val(w).change()}});if(!s(u)){return false}return w}function s(v){v=v.toString().replace(/\D/g,"").split("").reverse();if(!v.length){return false}var u=0;for(i=0;i<v.length;i++){v[i]=parseInt(v[i],10);u+=i%2?2*v[i]-(v[i]>4?9:0):v[i]}return(u%10)==0}});if(!locales){var locales=false};